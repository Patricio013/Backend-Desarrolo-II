<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Test – Solicitudes</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    input, button { padding: 6px 8px; margin: 4px 0; }
    #log { border: 1px solid #ccc; padding: 8px; height: 300px; overflow: auto; background:#fafafa; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    label { font-weight: 600; }
    .small { font-size: 12px; color:#666; }
  </style>
  <!-- CDN UMD builds -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h1>WebSocket Test – Solicitudes</h1>
  <div class="row">
    <label for="baseUrl">Base URL:</label>
    <input id="baseUrl" size="40" />
    <button id="connectBtn">Conectar</button>
    <span id="status" class="small">Desconectado</span>
  </div>

  <div class="row">
    <button id="subGeneral">Subscribir /topic/solicitudes</button>
    <label for="sid">Solicitud ID:</label>
    <input id="sid" type="number" min="1" style="width:120px" />
    <button id="subById">Subscribir /topic/solicitudes/{id}</button>
    <button id="crearDemo">Crear solicitud demo</button>
  </div>

  <div class="row">
    <button id="cancelar">PATCH cancelar</button>
    <button id="recotizar">PUT recotizar</button>
    <button id="invitarTop3">POST invitar-top3</button>
  </div>

  <pre id="log"></pre>

  <script>
    const log = (...args) => {
      const el = document.getElementById('log');
      el.textContent += args.map(a => typeof a === 'string' ? a : JSON.stringify(a, null, 2)).join(' ') + '\n';
      el.scrollTop = el.scrollHeight;
    };

    const $ = (id) => document.getElementById(id);
    const urlInput = $('baseUrl');
    urlInput.value = window.location.origin;

    let client = null;

    const connect = () => {
      const base = urlInput.value.replace(/\/$/, '');
      const sockUrl = base + '/ws';
      const sock = new SockJS(sockUrl);
      client = Stomp.over(sock);
      client.reconnect_delay = 2000;
      sock.onclose = () => { $('status').textContent = 'Desconectado'; log('WS cerrado'); };
      client.connect({}, () => {
        $('status').textContent = 'Conectado';
        log('Conectado a', sockUrl);
      }, (err) => {
        log('STOMP error:', err);
      });
    };

    const subscribeGeneral = () => {
      if (!client || !client.connected) return log('No conectado');
      client.subscribe('/topic/solicitudes', (msg) => {
        try { log('MSG general:', JSON.parse(msg.body)); } catch(e) { log('MSG general raw:', msg.body); }
      });
      log('Subscrito a /topic/solicitudes');
    };

    const subscribeById = () => {
      if (!client || !client.connected) return log('No conectado');
      const id = $('sid').value;
      if (!id) return log('Ingrese un ID de solicitud');
      client.subscribe(`/topic/solicitudes/${id}`, (msg) => {
        try { log(`MSG ${id}:`, JSON.parse(msg.body)); } catch(e) { log(`MSG ${id} raw:`, msg.body); }
      });
      log('Subscrito a /topic/solicitudes/' + id);
    };

    const callApi = async (method, path) => {
      const base = urlInput.value.replace(/\/$/, '');
      const url = base + path;
      try {
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' } });
        const text = await res.text();
        log(method, path, res.status, text);
      } catch (e) {
        log('ERROR', method, path, e.message);
      }
    };

    const callApiJson = async (method, path, body) => {
      const base = urlInput.value.replace(/\/$/, '');
      const url = base + path;
      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const text = await res.text();
        log(method, path, res.status, text);
      } catch (e) {
        log('ERROR', method, path, e.message);
      }
    };

    $('connectBtn').onclick = connect;
    $('subGeneral').onclick = subscribeGeneral;
    $('subById').onclick = subscribeById;

    $('cancelar').onclick = () => {
      const id = $('sid').value;
      if (!id) return log('Ingrese un ID de solicitud');
      callApi('PATCH', `/api/solicitudes/${id}/cancelar`);
    };

    $('recotizar').onclick = () => {
      const id = $('sid').value;
      if (!id) return log('Ingrese un ID de solicitud');
      // Ojo: mapping es "path/{id}/recotizar" según backend actual
      callApi('PUT', `/api/solicitudes/path/${id}/recotizar`);
    };

    $('invitarTop3').onclick = () => {
      callApi('POST', '/api/solicitudes/invitar-top3');
    };

    $('crearDemo').onclick = async () => {
      // Genero un ID único para la solicitud de prueba
      const solicitudId = Math.floor(1e8 + Math.random() * 9e8);
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      const fecha = `${yyyy}-${mm}-${dd}`;
      const body = [
        {
          solicitud_id: solicitudId,
          usuario_id: 1,
          rubro: 'Plomeria',
          descripcion: 'Prueba WS ' + new Date().toISOString(),
          preferencia_horaria: { dia: fecha, ventana: '09:00-13:00' }
        }
      ];
      $('sid').value = solicitudId;
      await callApiJson('POST', '/api/solicitudes/crear', body);
      if (client && client.connected) {
        subscribeById();
      }
    };
  </script>
</body>
</html>
